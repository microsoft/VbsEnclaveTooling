<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <VbsEnclaveExeFilePath>$(OutDir)edlcodegen.exe</VbsEnclaveExeFilePath>
        <VbsEnclaveEdlPath>$(SolutionDir)src\ToolingSharedLibrary\CurrentCodeGenerationState\CodeGenerationState.edl</VbsEnclaveEdlPath>
        <VbsEnclaveGeneratedFilesDir>$(SolutionDir)src\ToolingSharedLibrary\CurrentCodeGenerationState</VbsEnclaveGeneratedFilesDir>
        <VbsEnclaveNamespace>CodeGenTest</VbsEnclaveNamespace>
        <VbsEnclaveRustNamespace>code_gen_test</VbsEnclaveRustNamespace>
        <VbsEnclaveVtl0ClassName>CodeGenTestClass</VbsEnclaveVtl0ClassName>
        <FlatbuffersCompiler>$(SolutionDir)src\ToolingSharedLibrary\vcpkg_installed\x64-windows-static-cfg\x64-windows\tools\flatbuffers\flatc.exe</FlatbuffersCompiler>
    </PropertyGroup>

    <!-- 
        Generate the current state of the codegen for both HostApp and Enclave after building the tooling executable.
        See <repo-root>\src\ToolingSharedLibrary\CurrentCodeGenerationState\Readme.md for more information.
    -->
    <Target
        Name="GenerateCodeGenCurrentState"
        AfterTargets="Build">

        <!-- Remove old generated files  -->
        <RemoveDir Directories="$(VbsEnclaveGeneratedFilesDir)\Cpp;$(VbsEnclaveGeneratedFilesDir)\Rust" />

        <!-- Generate the codegen files for Cpp -->
        <PropertyGroup>
            <CppCodeGenForEnclaveCommand>
                "$(VbsEnclaveExeFilePath)" --Language C++ --EdlPath "$(VbsEnclaveEdlPath)" --OutputDirectory "$(VbsEnclaveGeneratedFilesDir)\Cpp" --VirtualTrustLayer "Enclave" --Vtl0ClassName "$(VbsEnclaveVtl0ClassName)" --Namespace "$(VbsEnclaveNamespace)" --FlatbuffersCompilerPath "$(FlatbuffersCompiler)"
            </CppCodeGenForEnclaveCommand>

            <CppCodeGenForHostAppCommand>
                "$(VbsEnclaveExeFilePath)" --Language C++ --EdlPath "$(VbsEnclaveEdlPath)" --OutputDirectory "$(VbsEnclaveGeneratedFilesDir)\Cpp" --VirtualTrustLayer "HostApp" --Vtl0ClassName "$(VbsEnclaveVtl0ClassName)" --Namespace "$(VbsEnclaveNamespace)" --FlatbuffersCompilerPath "$(FlatbuffersCompiler)"
            </CppCodeGenForHostAppCommand>
        </PropertyGroup>

        <!-- Generate the codegen files for Rust -->
        <PropertyGroup>
            <RustCodeGenForEnclaveCommand>
                "$(VbsEnclaveExeFilePath)" --Language Rust --EdlPath "$(VbsEnclaveEdlPath)" --OutputDirectory "$(VbsEnclaveGeneratedFilesDir)\Rust\Enclave" --VirtualTrustLayer "Enclave" --Vtl0ClassName "$(VbsEnclaveVtl0ClassName)" --Namespace "$(VbsEnclaveRustNamespace)" --FlatbuffersCompilerPath "$(FlatbuffersCompiler)"
            </RustCodeGenForEnclaveCommand>

            <RustCodeGenForHostAppCommand>
                "$(VbsEnclaveExeFilePath)" --Language Rust --EdlPath "$(VbsEnclaveEdlPath)" --OutputDirectory "$(VbsEnclaveGeneratedFilesDir)\Rust\HostApp" --VirtualTrustLayer "HostApp" --Vtl0ClassName "$(VbsEnclaveVtl0ClassName)" --Namespace "$(VbsEnclaveRustNamespace)" --FlatbuffersCompilerPath "$(FlatbuffersCompiler)"
            </RustCodeGenForHostAppCommand>
        </PropertyGroup>

        <Message Text="Generating current state of codegen for Cpp Enclave." Importance="high" />
        <Exec Command="$(CppCodeGenForEnclaveCommand)" />

        <Message Text="Generating current state of codegen for Cpp Host." Importance="high" />
        <Exec Command="$(CppCodeGenForHostAppCommand)" />

        <Message Text="Generating current state of codegen for Rust Enclave." Importance="high" />
        <Exec Command="$(RustCodeGenForEnclaveCommand)" />

        <Message Text="Generating current state of codegen for Rust Host." Importance="high" />
        <Exec Command="$(RustCodeGenForHostAppCommand)" />
    </Target>
</Project>
