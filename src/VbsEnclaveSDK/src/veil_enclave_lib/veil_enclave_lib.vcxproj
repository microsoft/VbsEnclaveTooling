<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- 
      Only use the Windows SDK props from nuget if the Windows native compiler is not enabled.
      Note: WindowsNativeCompilerEnabled is passed to the solution via an Azure pipeline job.
    -->
  <ImportGroup Label="CppSdkNugetProps" Condition="'$(WindowsNativeCompilerEnabled)'!='true'">
    <Import Project="$(SolutionDir)packages\Microsoft.Windows.SDK.CPP.10.0.26100.7175\build\native\Microsoft.Windows.SDK.cpp.props" Condition="Exists('$(SolutionDir)packages\Microsoft.Windows.SDK.CPP.10.0.26100.7175\build\native\Microsoft.Windows.SDK.cpp.props')" />
    <Import Project="$(SolutionDir)packages\Microsoft.Windows.SDK.CPP.arm64.10.0.26100.7175\build\native\Microsoft.Windows.SDK.cpp.arm64.props" Condition="Exists('$(SolutionDir)packages\Microsoft.Windows.SDK.CPP.arm64.10.0.26100.7175\build\native\Microsoft.Windows.SDK.cpp.arm64.props')" />
    <Import Project="$(SolutionDir)packages\Microsoft.Windows.SDK.CPP.x64.10.0.26100.7175\build\native\Microsoft.Windows.SDK.cpp.x64.props" Condition="Exists('$(SolutionDir)packages\Microsoft.Windows.SDK.CPP.x64.10.0.26100.7175\build\native\Microsoft.Windows.SDK.cpp.x64.props')" />
  </ImportGroup>
  <Import Project="$(SolutionDir)packages\Microsoft.Windows.VbsEnclave.CodeGenerator.0.2.260106.1\build\native\Microsoft.Windows.VbsEnclave.CodeGenerator.props" Condition="Exists('$(SolutionDir)packages\Microsoft.Windows.VbsEnclave.CodeGenerator.0.2.260106.1\build\native\Microsoft.Windows.VbsEnclave.CodeGenerator.props')" />
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|ARM64">
      <Configuration>Debug</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM64">
      <Configuration>Release</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <Keyword>Win32Proj</Keyword>
    <ProjectGuid>{323433E4-11D6-4B5B-93E4-04504E2EF0E1}</ProjectGuid>
    <RootNamespace>veil_enclave_lib</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
    <ConfigurationType>StaticLibrary</ConfigurationType>
    <PlatformToolset>v143</PlatformToolset>
    <ProjectName>veil_enclave_lib</ProjectName>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <Import Project="$(ProjectDir)..\..\veil_abi.props" />
  <Import Project="$(SolutionDir)..\..\Common\veil_enclave_cpp_support_lib\Enclave.Hybrid.Ucrt.props"/>
  <ImportGroup Label="Shared">
    <Import Project="..\veil_any_inc\veil_any_inc.vcxitems" Label="Shared" />
  </ImportGroup>
  <ImportGroup Label="ExtensionSettings" />
  <PropertyGroup>
    <TargetName>veil_enclave</TargetName>
    <LinkIncremental>false</LinkIncremental>
    <IntDir>$(Platform)\$(Configuration)\</IntDir>
  </PropertyGroup>
  <PropertyGroup>
    <IncludePath>$(VC_IncludePath);$(WindowsSDK_IncludePath)</IncludePath>
  </PropertyGroup>
  <!-- Toggle for _VEIL_INTERNAL_DEBUG - can be overridden via command line or parent props files -->
  <PropertyGroup>
    <EnableVeilInternalDebug Condition="'$(EnableVeilInternalDebug)' == ''">false</EnableVeilInternalDebug>
  </PropertyGroup>
  <ImportGroup Label="Shared">
    <Import Project="$(SolutionDir)packages\Microsoft.Windows.ImplementationLibrary.1.0.240803.1\build\native\Microsoft.Windows.ImplementationLibrary.targets" Condition="Exists('$(SolutionDir)packages\Microsoft.Windows.ImplementationLibrary.1.0.240803.1\build\native\Microsoft.Windows.ImplementationLibrary.targets')" />
    <Import Project="$(SolutionDir)packages\Microsoft.Windows.VbsEnclave.CodeGenerator.0.2.260106.1\build\native\Microsoft.Windows.VbsEnclave.CodeGenerator.targets" Condition="Exists('$(SolutionDir)packages\Microsoft.Windows.VbsEnclave.CodeGenerator.0.2.260106.1\build\native\Microsoft.Windows.VbsEnclave.CodeGenerator.targets')" />
  </ImportGroup>
  <!--  
    Override the AddGeneratedFilesToBuild target from the codegenerator in favor of adding the
	generated cpp files to the build directly using the vcxproj file. There seems to be
	an issue with the target when using the Windows native compiler.
  -->
  <Target Name="AddGeneratedFilesToBuild" Condition="'$(WindowsNativeCompilerEnabled)' == 'true'"></Target>
  <ItemGroup Condition="'$(WindowsNativeCompilerEnabled)' == 'true'">
    <ClCompile Include="Generated Files\VbsEnclave\Enclave\Abi\Exports.veil_abi.cpp" />
    <ClCompile Include="Generated Files\VbsEnclave\Enclave\Abi\LinkerPragmas.veil_abi.cpp" />
  </ItemGroup>

  <!-- 
    Only use the Windows SDK target from nuget if the Windows native compiler is not enabled.
    Note: WindowsNativeCompilerEnabled is passed to the solution via an Azure pipeline job.
  -->
  <ImportGroup Label="CppSdkNugetTarget" Condition="'$(WindowsNativeCompilerEnabled)'!='true'">
    <Import Project="$(SolutionDir)packages\Microsoft.Windows.SDK.CPP.10.0.26100.7175\build\native\Microsoft.Windows.SDK.cpp.targets" Condition="Exists('$(SolutionDir)packages\Microsoft.Windows.SDK.CPP.10.0.26100.7175\build\native\Microsoft.Windows.SDK.cpp.targets')" />
  </ImportGroup>
  <PropertyGroup>
    <!-- Unclear why this variable doesn't exist in the .nuget pkg for the SDK -->
    <WindowsSdk_EnclaveIncludes_Path>$(WindowsSdkDir)Include\$(WindowsSDKBuildToolsVersion)</WindowsSdk_EnclaveIncludes_Path>
  </PropertyGroup>
  <PropertyGroup>
    <VbsEnclaveVirtualTrustLayer>Enclave</VbsEnclaveVirtualTrustLayer>
    <VbsEnclaveConsumeCppSupportLib>true</VbsEnclaveConsumeCppSupportLib>
  </PropertyGroup>
  <!-- Conditional _VEIL_INTERNAL_DEBUG definition based on EnableVeilInternalDebug property -->
  <ItemDefinitionGroup Condition="'$(EnableVeilInternalDebug)' == 'true'">
    <ClCompile>
      <PreprocessorDefinitions>_VEIL_INTERNAL_DEBUG;%(PreprocessorDefinitions)</PreprocessorDefinitions>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup>
    <ClCompile>
      <WarningLevel>Level4</WarningLevel>
      <TreatWarningAsError>true</TreatWarningAsError>
      <DisableSpecificWarnings>%(DisableSpecificWarnings)</DisableSpecificWarnings>
      <SDLCheck>true</SDLCheck>
      <DebugInformationFormat>ProgramDatabase</DebugInformationFormat>
      <BasicRuntimeChecks>Default</BasicRuntimeChecks>
      <LanguageStandard_C>stdc17</LanguageStandard_C>
      <RuntimeTypeInfo>false</RuntimeTypeInfo>
      <PrecompiledHeader>NotUsing</PrecompiledHeader>
      <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
      <AdditionalIncludeDirectories>$(SdkNugetHeaderIncludes);$(WindowsSdk_EnclaveIncludes_Path)\um;$(WindowsSdk_EnclaveIncludes_Path)\shared;$(WindowsSdk_EnclaveIncludes_Path)\ucrt;$(SolutionDir)..\..\Common\veil_enclave_wil_inc;$(MSBUILDThisFileDirectory)..\veil_enclave_inc;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
      <LanguageStandard>stdcpp20</LanguageStandard>
      <GuardEHContMetadata>true</GuardEHContMetadata>
      <TreatWChar_tAsBuiltInType Condition="'$(WindowsNativeCompilerEnabled)'=='true'">false</TreatWChar_tAsBuiltInType>
    </ClCompile>
    <Link>
      <SubSystem>Console</SubSystem>
      <CETCompat Condition="'$(Configuration)|$(Platform)'=='Release|x64'">true</CETCompat>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClInclude Include="..\..\..\..\Common\veil_enclave_wil_inc\wil\enclave\pop_enable_wil_logging.h" />
    <ClInclude Include="..\..\..\..\Common\veil_enclave_wil_inc\wil\enclave\push_disable_wil_logging.h" />
    <ClInclude Include="..\..\..\..\Common\veil_enclave_wil_inc\wil\enclave\wil_for_enclaves.h" />
    <ClInclude Include="crypto.vtl1.h" />
    <ClInclude Include="future.vtl1.h" />
    <ClInclude Include="object_table.vtl1.h" />
    <ClInclude Include="logger.vtl1.h" />
    <ClInclude Include="userboundkey.vtl1.h" />
    <ClInclude Include="vtl0_functions.vtl1.h" />
    <ClInclude Include="pch.h" />
    <ClInclude Include="taskpool.vtl1.h" />
    <ClInclude Include="utils.vtl1.h" />
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="logger.vtl1.cpp" />
    <ClCompile Include="pch.cpp">
      <PrecompiledHeader>Create</PrecompiledHeader>
    </ClCompile>
    <ClCompile Include="taskpool.vtl1.cpp" />
    <ClCompile Include="userboundkey.vtl1.cpp" />
    <ClCompile Include="vtl0_functions.vtl1.cpp" />
  </ItemGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ItemGroup>
    <None Include="packages.config" />
  </ItemGroup>
  <!-- Enable synchronized LKG and internal MsUCRT consumption  -->
  <PropertyGroup>
    <UseInternalMSUniCrtPackage>true</UseInternalMSUniCrtPackage>
    <UseHalfStaticOSMode>false</UseHalfStaticOSMode>
    <UseEnclave>True</UseEnclave>
  </PropertyGroup>
  <Target Name="EnsureNuGetPackageBuildImports" BeforeTargets="PrepareForBuild">
    <PropertyGroup>
      <ErrorText>This project references NuGet package(s) that are missing on this computer. Use NuGet Package Restore to download them.  For more information, see http://go.microsoft.com/fwlink/?LinkID=322105. The missing file is {0}.</ErrorText>
    </PropertyGroup>
    <Error Condition="!Exists('$(SolutionDir)packages\Microsoft.Windows.ImplementationLibrary.1.0.240803.1\build\native\Microsoft.Windows.ImplementationLibrary.targets')" Text="$([System.String]::Format('$(ErrorText)', '$(SolutionDir)packages\Microsoft.Windows.ImplementationLibrary.1.0.240803.1\build\native\Microsoft.Windows.ImplementationLibrary.targets'))" />
    <Error Condition="!Exists('$(SolutionDir)packages\Microsoft.Windows.VbsEnclave.CodeGenerator.0.2.260106.1\build\native\Microsoft.Windows.VbsEnclave.CodeGenerator.props')" Text="$([System.String]::Format('$(ErrorText)', '$(SolutionDir)packages\Microsoft.Windows.VbsEnclave.CodeGenerator.0.2.260106.1\build\native\Microsoft.Windows.VbsEnclave.CodeGenerator.props'))" />
    <Error Condition="!Exists('$(SolutionDir)packages\Microsoft.Windows.VbsEnclave.CodeGenerator.0.2.260106.1\build\native\Microsoft.Windows.VbsEnclave.CodeGenerator.targets')" Text="$([System.String]::Format('$(ErrorText)', '$(SolutionDir)packages\Microsoft.Windows.VbsEnclave.CodeGenerator.0.2.260106.1\build\native\Microsoft.Windows.VbsEnclave.CodeGenerator.targets'))" />
  </Target>
</Project>
