parameters: 
- name: ReleaseTarget
  type: string
  default: 'EdlCodeGen'
  values:
  - EdlCodeGen
  - SDK

resources:
  repositories:
  - repository: templates
    type: git
    name: OneBranch.Pipelines/GovernedTemplates
    ref: refs/heads/main
  pipelines:
  # Reference pipeline that created the signed nupkg artifacts so we can consume them later
  - pipeline: VbsEnclaveTooling 
    source: 'Vbs Enclave Tooling OneBranch (Official Build)'
    trigger: none

variables:
  ${{ if eq(parameters.ReleaseTarget, 'EdlCodeGen') }}:
    ArtifactName: 'codegen_content-nuget'
  ${{ else }}:
    ArtifactName: 'sdk_content-nuget'

extends:
  template: v2/OneBranch.Official.CrossPlat.yml@templates
  parameters:
    release:
      category: NonAzure
    featureFlags:
      use1esentry: false

    stages:
    - stage: 'Publish'
      displayName: 'Publish to NuGet'
      variables:
        ob_release_environment: Production

      jobs:
      - job: ReleaseToNugetOrg
        pool:
          type: release
        variables:
          ob_nugetPublishing_enabled: true
        templateContext:
          inputs:
          - input: pipelineArtifact
            pipeline: VbsEnclaveTooling
            artifactName: $(ArtifactName)

        steps:
        - task: NuGetCommand@2
          displayName: 'Push nuget package to nuget.org'
          inputs:
            command: push
            packagesToPush: '$(Pipeline.Workspace)\Microsoft.Windows.VbsEnclave.*.nupkg'
            nuGetFeedType: external
            publishFeedCredentials: 'VbsEnclaveTooling Nuget' # Service connection
